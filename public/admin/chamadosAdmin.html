<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Maximum Help • Chamados</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="../assets/css/style.css" />
</head>
<body>
  <div class="admin-shell">
    <aside class="sidebar" id="sidebar"></aside>

    <section class="main">
      <div class="topbar fade-in">
        <div class="d-flex align-items-center gap-2">
          <button class="sidebar-toggle" id="btnSidebarToggle" type="button">
            <i data-lucide="panel-left" style="width:18px;height:18px;"></i>
            Menu
          </button>
          <h1 id="moduleTitle">Chamados</h1>
          <span class="badge-accent"><i data-lucide="ticket" style="width:16px;height:16px;"></i>Suporte</span>
        </div>

        <div class="d-flex align-items-center gap-2">
          <button class="btn btn-outline-secondary" id="btnRefresh" style="border-radius:14px;">
            <i data-lucide="refresh-cw" style="width:18px;height:18px;"></i>
          </button>

          <button class="btn btn-accent" id="btnOpenCreate" data-bs-toggle="modal" data-bs-target="#modalTicket">
            <i data-lucide="plus" style="width:18px;height:18px;"></i>
            Abrir chamado
          </button>
        </div>
      </div>

      <div class="content">
        <div id="pageAlert"></div>

        <!-- filtros -->
        <div class="soft-card-sm p-3 fade-in">
          <div class="row g-2 align-items-end">
            <div class="col-12 col-lg-4">
              <label class="form-label" style="color:var(--muted); font-size:12px;">Buscar por título</label>
              <div class="position-relative">
                <i data-lucide="search" class="input-icon"></i>
                <input id="search" class="form-control with-icon" placeholder="Ex.: Impressora, Acesso, Sistema..." />
              </div>
            </div>

            <div class="col-12 col-md-4 col-lg-2">
              <label class="form-label" style="color:var(--muted); font-size:12px;">Status</label>
              <select id="filterStatus" class="form-select" style="border-radius:14px; min-height:46px; border:1px solid var(--border);">
                <option value="">Todos</option>
              </select>
            </div>

            <div class="col-12 col-md-4 col-lg-2">
              <label class="form-label" style="color:var(--muted); font-size:12px;">Urgência</label>
              <select id="filterUrgente" class="form-select" style="border-radius:14px; min-height:46px; border:1px solid var(--border);">
                <option value="">Todos</option>
                <option value="true">Urgentes</option>
                <option value="false">Não urgentes</option>
              </select>
            </div>

            <div class="col-12 col-md-6 col-lg-2">
              <label class="form-label" style="color:var(--muted); font-size:12px;">Setor</label>
              <select id="filterSetor" class="form-select" style="border-radius:14px; min-height:46px; border:1px solid var(--border);">
                <option value="">Todos</option>
              </select>
            </div>

            <div class="col-12 col-md-6 col-lg-2">
              <label class="form-label" style="color:var(--muted); font-size:12px;">Responsável</label>
              <select id="filterResp" class="form-select" style="border-radius:14px; min-height:46px; border:1px solid var(--border);">
                <option value="">Todos</option>
              </select>
            </div>

            <div class="col-12 d-flex gap-2 mt-1">
              <button class="btn btn-outline-secondary" id="btnClear" style="border-radius:14px;">
                Limpar
              </button>
              <button class="btn btn-accent" id="btnApply" style="border-radius:14px;">
                Aplicar filtros
              </button>
            </div>
          </div>

          <hr style="border-color: var(--border);" />

          <!-- tabela -->
          <div class="table-responsive">
            <table class="table align-middle mb-0">
              <thead>
                <tr style="color:var(--muted); font-size:12px;">
                  <th>Título</th>
                  <th>Status</th>
                  <th>Prioridade</th>
                  <th>Urgente</th>
                  <th>Responsável</th>
                  <th>Setor</th>
                  <th class="text-end">Ações</th>
                </tr>
              </thead>
              <tbody id="tblBody">
                <tr><td colspan="7" style="color:var(--muted);">Carregando...</td></tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </section>
  </div>

  <!-- MODAL CRIAR/EDITAR -->
  <div class="modal fade" id="modalTicket" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-xl modal-dialog-centered">
      <div class="modal-content soft-card">
        <div class="modal-header border-0">
          <div>
            <h5 class="modal-title" id="modalTitle" style="font-weight:900;">Abrir chamado</h5>
            <div style="color:var(--muted); font-size:12px;">Preencha os dados e atribua um responsável.</div>
          </div>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
        </div>

        <div class="modal-body pt-0">
          <div id="modalAlert"></div>
          <input type="hidden" id="ticketId" />

          <div class="row g-3">
            <div class="col-12 col-lg-6">
              <label class="form-label" style="color:var(--muted); font-size:12px;">Título</label>
              <div class="position-relative">
                <i data-lucide="text" class="input-icon"></i>
                <input id="titulo" class="form-control with-icon" placeholder="Ex.: Computador não liga" />
              </div>
            </div>

            <div class="col-12 col-lg-3">
              <label class="form-label" style="color:var(--muted); font-size:12px;">Prioridade</label>
              <select id="prioridade" class="form-select" style="border-radius:14px; min-height:46px; border:1px solid var(--border);">
                <option>Baixa</option>
                <option selected>Média</option>
                <option>Alta</option>
              </select>
            </div>

            <div class="col-12 col-lg-3">
              <label class="form-label" style="color:var(--muted); font-size:12px;">Status</label>
              <select id="status" class="form-select" style="border-radius:14px; min-height:46px; border:1px solid var(--border);">
              </select>
            </div>

            <div class="col-12">
              <label class="form-label" style="color:var(--muted); font-size:12px;">Descrição</label>
              <textarea id="descricao" class="form-control" rows="4" style="border-radius:14px; border:1px solid var(--border);" placeholder="Descreva o problema..."></textarea>
            </div>

            <div class="col-12 col-lg-3">
              <label class="form-label" style="color:var(--muted); font-size:12px;">Urgente?</label>
              <select id="urgente" class="form-select" style="border-radius:14px; min-height:46px; border:1px solid var(--border);">
                <option value="false" selected>Não</option>
                <option value="true">Sim</option>
              </select>
            </div>

            <div class="col-12 col-lg-3">
              <label class="form-label" style="color:var(--muted); font-size:12px;">Data início</label>
              <input id="dataInicio" type="date" class="form-control" style="border-radius:14px; min-height:46px; border:1px solid var(--border);" />
            </div>

            <div class="col-12 col-lg-3">
              <label class="form-label" style="color:var(--muted); font-size:12px;">Data fim</label>
              <input id="dataFim" type="date" class="form-control" style="border-radius:14px; min-height:46px; border:1px solid var(--border);" />
            </div>

            <div class="col-12 col-lg-3">
              <label class="form-label" style="color:var(--muted); font-size:12px;">Responsável</label>
              <select id="responsavel" class="form-select" style="border-radius:14px; min-height:46px; border:1px solid var(--border);">
                <option value="">Carregando...</option>
              </select>
            </div>

            <div class="col-12 col-lg-6">
              <label class="form-label" style="color:var(--muted); font-size:12px;">
                Setor (auto quando o responsável tem setor)
              </label>
              <select id="setor" class="form-select" style="border-radius:14px; min-height:46px; border:1px solid var(--border);">
                <option value="">Carregando...</option>
              </select>
              <div style="color:var(--muted); font-size:12px;" class="mt-2">
                Se o responsável tiver setor, o backend define automaticamente. Se não tiver, selecione manualmente.
              </div>
            </div>
          </div>
        </div>

        <div class="modal-footer border-0">
          <button class="btn btn-outline-secondary" data-bs-dismiss="modal" style="border-radius:14px;">Cancelar</button>
          <button class="btn btn-accent" id="btnSave" style="border-radius:14px;">
            <span id="btnSaveText">Salvar</span>
            <span id="btnSaveSpin" class="spinner-border spinner-border-sm ms-2 d-none" role="status"></span>
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- MODAL DETALHES + CHAT -->
  <div class="modal fade" id="modalDetails" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-xl modal-dialog-centered">
      <div class="modal-content soft-card">
        <div class="modal-header border-0">
          <div>
            <h5 class="modal-title" id="detailsTitle" style="font-weight:900;">Detalhes do chamado</h5>
            <div id="detailsMeta" style="color:var(--muted); font-size:12px;"></div>
          </div>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
        </div>

        <div class="modal-body pt-0">
          <div id="detailsAlert"></div>

          <div class="row g-3">
            <div class="col-12 col-lg-6">
              <div class="soft-card-sm p-3">
                <div style="font-weight:900;">Resumo</div>
                <div id="detailsInfo" class="mt-2" style="color:var(--muted);"></div>

                <div class="mt-3">
                  <label class="form-label" style="color:var(--muted); font-size:12px;">Alterar status rápido</label>
                  <div class="d-flex gap-2">
                    <select id="quickStatus" class="form-select" style="border-radius:14px; min-height:46px; border:1px solid var(--border);"></select>
                    <button class="btn btn-accent" id="btnQuickStatus" style="border-radius:14px;">
                      Aplicar
                    </button>
                  </div>
                </div>
              </div>
            </div>

            <div class="col-12 col-lg-6">
              <div class="soft-card-sm p-3">
                <div class="d-flex align-items-center justify-content-between">
                  <div>
                    <div style="font-weight:900;">Atualizações</div>
                    <div style="color:var(--muted); font-size:12px;">Estilo chat (autor/data/hora)</div>
                  </div>
                </div>

                <div id="chatBox" class="mt-3" style="max-height:320px; overflow:auto;"></div>

                <hr style="border-color: var(--border);" />

                <div class="row g-2">
                  <div class="col-12">
                    <textarea id="msg" class="form-control" rows="2" style="border-radius:14px; border:1px solid var(--border);" placeholder="Escreva uma atualização..."></textarea>
                  </div>
                  <div class="col-12 col-lg-8">
                    <input id="anexo" class="form-control" style="border-radius:14px; min-height:46px; border:1px solid var(--border);" placeholder="Anexo (opcional) - URL ou nome do arquivo" />
                  </div>
                  <div class="col-12 col-lg-4 d-grid">
                    <button class="btn btn-accent" id="btnSendUpdate" style="border-radius:14px; min-height:46px;">
                      Enviar atualização
                    </button>
                  </div>
                </div>

              </div>
            </div>
          </div>

        </div>

        <div class="modal-footer border-0">
          <button class="btn btn-outline-secondary" data-bs-dismiss="modal" style="border-radius:14px;">Fechar</button>
        </div>
      </div>
    </div>
  </div>

  <!-- MODAL EXCLUIR -->
  <div class="modal fade" id="modalDelete" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content soft-card">
        <div class="modal-header border-0">
          <h5 class="modal-title" style="font-weight:900;">Excluir chamado</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
        </div>
        <div class="modal-body pt-0" style="color:var(--muted);">
          Tem certeza que deseja excluir <strong id="delName"></strong>?
          <div class="mt-2" style="font-size:12px;">Essa ação não poderá ser desfeita.</div>
          <input type="hidden" id="delId" />
        </div>
        <div class="modal-footer border-0">
          <button class="btn btn-outline-secondary" data-bs-dismiss="modal" style="border-radius:14px;">Cancelar</button>
          <button class="btn btn-danger" id="btnConfirmDelete" style="border-radius:14px;">Excluir</button>
        </div>
      </div>
    </div>
  </div>

  <script src="https://unpkg.com/lucide@latest"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  <script src="../assets/js/api.js"></script>
  <script src="../assets/js/adminCommon.js"></script>
  <script src="../assets/js/chamadosAdmin.js"></script>
</body>
</html>
